<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Música Brillante v2</title>
    <style>
        /* --- CSS Starts (Estilo "Brillante" - sin cambios respecto a la versión anterior) --- */
        :root {
            --bg-color: #fdf6e3; --player-bg: #fffbf0; --accent-orange: #f57c00;
            --accent-green: #388e3c; --icon-color: #424242; --text-light: #666;
            --shadow-color-dark: rgba(211, 189, 143, 0.5); --shadow-color-light: rgba(255, 255, 255, 0.8);
            --border-radius-main: 16px; --border-radius-inner: 10px;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--icon-color);
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        h1 { color: var(--icon-color); font-weight: 600; }
        .container { display: flex; flex-wrap: wrap; gap: 25px; width: 100%; max-width: 1000px; justify-content: center; }
        .player { background-color: var(--player-bg); border-radius: var(--border-radius-main); padding: 25px; box-shadow: 8px 8px 16px var(--shadow-color-dark), -8px -8px 16px var(--shadow-color-light); width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; gap: 18px; }
        .playlist-container { background-color: var(--player-bg); border-radius: var(--border-radius-main); padding: 20px; box-shadow: 8px 8px 16px var(--shadow-color-dark), -8px -8px 16px var(--shadow-color-light); width: 100%; max-width: 520px; flex-grow: 1; height: 480px; overflow-y: auto; }
        #fileInputLabel { display: inline-block; padding: 12px 25px; background-color: var(--player-bg); color: var(--accent-orange); font-weight: 600; border-radius: var(--border-radius-main); cursor: pointer; box-shadow: 5px 5px 10px var(--shadow-color-dark), -5px -5px 10px var(--shadow-color-light); transition: all 0.15s ease-in-out; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
        #fileInputLabel:hover { color: #ef6c00; box-shadow: 6px 6px 12px var(--shadow-color-dark), -6px -6px 12px var(--shadow-color-light); }
        #fileInputLabel:active { box-shadow: inset 4px 4px 8px var(--shadow-color-dark), inset -4px -4px 8px var(--shadow-color-light); transform: scale(0.98); }
        #fileInput { display: none; }
        #albumArtContainer { width: 200px; height: 200px; background-color: #eee; border-radius: var(--border-radius-inner); overflow: hidden; box-shadow: inset 4px 4px 8px var(--shadow-color-dark), inset -4px -4px 8px var(--shadow-color-light); display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        #albumArt { width: 100%; height: 100%; object-fit: cover; display: none; color: #bbb; font-size: 1em; text-align: center; }
        #artPlaceholder { width: 60px; height: 60px; color: #ccc; display: inline-block; }
        #trackInfo { text-align: center; }
        #trackTitle { font-weight: 600; display: block; font-size: 1.2em; margin-bottom: 4px; color: #333;}
        #trackArtistAlbum { font-size: 0.95em; color: var(--text-light); }
        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; }
        #progressBar { flex-grow: 1; appearance: none; width: 100%; height: 10px; background: transparent; outline: none; cursor: pointer; border-radius: 5px; box-shadow: inset 3px 3px 6px var(--shadow-color-dark), inset -3px -3px 6px var(--shadow-color-light); }
        #progressBar::-webkit-slider-runnable-track { height: 10px; background: transparent; border-radius: 5px; }
        #progressBar::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--accent-orange); border-radius: 50%; cursor: pointer; margin-top: -4px; box-shadow: 3px 3px 6px var(--shadow-color-dark), -3px -3px 6px var(--shadow-color-light); border: 1px solid rgba(0,0,0,0.1); }
        #progressBar::-moz-range-track { height: 10px; background: transparent; border-radius: 5px; }
        #progressBar::-moz-range-thumb { width: 18px; height: 18px; background: var(--accent-orange); border-radius: 50%; border: none; cursor: pointer; box-shadow: 3px 3px 6px var(--shadow-color-dark), -3px -3px 6px var(--shadow-color-light); }
        .time-display { font-size: 0.85em; white-space: nowrap; color: var(--text-light); font-weight: 500; }
        .controls { display: flex; align-items: center; justify-content: space-around; gap: 15px; width: 100%; padding: 10px 0; }
        .control-button { background-color: var(--player-bg); border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--icon-color); box-shadow: 4px 4px 8px var(--shadow-color-dark), -4px -4px 8px var(--shadow-color-light); transition: all 0.1s ease-in-out; }
        .control-button svg { width: 22px; height: 22px; display: block; fill: currentColor;}
        .control-button:hover { color: #000; box-shadow: 5px 5px 10px var(--shadow-color-dark), -5px -5px 10px var(--shadow-color-light); }
        .control-button:active { box-shadow: inset 3px 3px 6px var(--shadow-color-dark), inset -3px -3px 6px var(--shadow-color-light); transform: scale(0.95); color: var(--accent-orange); }
        #playPauseButton { width: 64px; height: 64px; background-color: var(--player-bg); }
        #playPauseButton svg { width: 32px; height: 32px; }
        #playPauseButton .play-icon { color: var(--accent-green); }
        #playPauseButton .pause-icon { color: var(--accent-orange); }
        #playPauseButton:active .play-icon, #playPauseButton:active .pause-icon { color: #d84315; }
        .volume-container { display: flex; align-items: center; gap: 8px; width: 100%; max-width: 150px; margin-top: 5px;}
        .volume-container svg { width: 18px; height: 18px; color: var(--text-light); }
        #volumeSlider { appearance: none; width: 100%; height: 6px; background: transparent; border-radius: 3px; outline: none; cursor: pointer; box-shadow: inset 2px 2px 4px var(--shadow-color-dark), inset -2px -2px 4px var(--shadow-color-light); }
        #volumeSlider::-webkit-slider-runnable-track { height: 6px; background: transparent; border-radius: 3px;}
        #volumeSlider::-moz-range-track { height: 6px; background: transparent; border-radius: 3px;}
        #volumeSlider::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--icon-color); border-radius: 50%; margin-top: -4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.4);}
        #volumeSlider::-moz-range-thumb { width: 14px; height: 14px; background: var(--icon-color); border-radius: 50%; border: none; }
        .playlist-container h3 { margin-top: 5px; margin-bottom: 15px; text-align: center; color: var(--text-light); font-weight: 500; }
        #fileList { list-style: none; padding: 0; margin: 0; }
        #fileList li { padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; font-size: 0.95em; border-radius: 6px; margin-bottom: 5px; transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-light); background-color: var(--player-bg); box-shadow: 3px 3px 6px var(--shadow-color-dark), -3px -3px 6px var(--shadow-color-light); }
        #fileList li:hover { background-color: #f9f0d5; color: var(--icon-color); }
        #fileList li.playing { background-color: #ffe8cc; font-weight: 600; color: #c06000; box-shadow: inset 3px 3px 6px var(--shadow-color-dark), inset -3px -3px 6px var(--shadow-color-light); }
        #fileList li:last-child { border-bottom: none; }
        .icon { display: inline-block; width: 1em; height: 1em; stroke-width: 0; stroke: currentColor; fill: currentColor; vertical-align: middle;}
        .hidden { display: none; }
        /* --- CSS Ends --- */
    </style>
</head>
<body>

    <h1>Reproductor Brillante v2</h1>

    <label for="fileInput" id="fileInputLabel">Seleccionar Archivos (MP3, M4A, MP4)</label>
    <input type="file" id="fileInput" multiple accept=".mp3,.mp4,.m4a">

    <div class="container">
        <div class="player">
             <div id="albumArtContainer">
                 <svg class="icon" id="artPlaceholder" style="width: 60px; height: 60px; color: #ccc;" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5h-1.5V14h-1v3H8v-3H7v4.5H5.5v-5c0-.55.45-1 1-1H11c.55 0 1 .45 1 1v5H9.5v-1.5h-1V17H12v1.5zm4.5-4.5c0-.55-.45-1-1-1h-2v1.5h1.5v1h-1.5V17h2c.55 0 1-.45 1-1v-4zm0-2.5h-4V9h4v1.5z"/></svg>
                <img id="albumArt" src="" alt="">
            </div>
            <div id="trackInfo">
                <span id="trackTitle">Selecciona archivos...</span>
                <span id="trackArtistAlbum"></span>
            </div>
             <div class="progress-container">
                 <span id="currentTime" class="time-display">0:00</span>
                 <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
                 <span id="duration" class="time-display">0:00</span>
             </div>
             <div class="controls">
                  <button class="control-button" id="prevButton" title="Anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M6 6h3.5v12H6zm5 6 8.5 6V6l-8.5 6z"/></svg></button>
                  <button class="control-button" id="playPauseButton" title="Reproducir/Pausa">
                       <svg class="icon play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7L8 5z"/></svg>
                       <svg class="icon pause-icon hidden" viewBox="0 0 24 24"><path d="M6 19h5V5H6v14zm7-14v14h5V5h-5z"/></svg>
                  </button>
                  <button class="control-button" id="nextButton" title="Siguiente"><svg class="icon" viewBox="0 0 24 24"><path d="M14.5 18l8.5-6-8.5-6v12zm-10 0h3.5V6H4.5v12z"/></svg></button>
             </div>
              <div class="volume-container">
                  <svg class="icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-.9-3.29-2.24-4.03v8.05c1.34-.74 2.24-2.26 2.24-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
              </div>
        </div>
        <div class="playlist-container">
            <h3>Lista de Reproducción</h3>
            <ul id="fileList"></ul>
        </div>
    </div>

    <audio id="audioPlayer"></audio>
    <video id="videoPlayer" style="display: none;"></video>

    <script>
        // --- JavaScript Starts ---
        window.addEventListener('load', () => {
            console.log("App loaded. Setting up elements...");
            // --- Element References --- (Identical to previous version)
            const fileInput=document.getElementById('fileInput'),fileListDisplay=document.getElementById('fileList'),audioPlayer=document.getElementById('audioPlayer'),videoPlayer=document.getElementById('videoPlayer'),playPauseButton=document.getElementById('playPauseButton'),prevButton=document.getElementById('prevButton'),nextButton=document.getElementById('nextButton'),progressBar=document.getElementById('progressBar'),currentTimeDisplay=document.getElementById('currentTime'),durationDisplay=document.getElementById('duration'),volumeSlider=document.getElementById('volumeSlider'),albumArtImg=document.getElementById('albumArt'),albumArtContainer=document.getElementById('albumArtContainer'),artPlaceholder=document.getElementById('artPlaceholder'),trackTitle=document.getElementById('trackTitle'),trackArtistAlbum=document.getElementById('trackArtistAlbum'),playIcon=playPauseButton.querySelector('.play-icon'),pauseIcon=playPauseButton.querySelector('.pause-icon');

            // --- State Variables --- (Identical)
            let trackList=[],currentTrackIndex=-1,isPlaying=false,currentAudioSource=audioPlayer,currentObjectURL=null;

            // --- jsmediatags Check (Keep check, but library is commented out) ---
            const jsmediatags = window.jsmediatags; // Will be undefined if script tag is commented out
            if(!jsmediatags){console.warn("jsmediatags library not loaded (expected if commented out). Metadata disabled.");}else{console.log("jsmediatags library loaded.");}

             // --- Initial UI State --- (Identical)
             albumArtImg.style.display = 'none'; artPlaceholder.style.display = 'inline-block';

            // --- Event Listeners --- (Mostly Identical, ensure error listener exists)
             console.log("Adding event listeners...");
             fileInput.addEventListener('change', handleFileSelection);
             playPauseButton.addEventListener('click', togglePlayPause); // Critical listener
             prevButton.addEventListener('click', playPreviousTrack);
             nextButton.addEventListener('click', playNextTrack);
             progressBar.addEventListener('input', handleSeek);
             volumeSlider.addEventListener('input', handleVolumeChange);
             [audioPlayer, videoPlayer].forEach(player => {
                 player.addEventListener('timeupdate', updateProgress);
                 player.addEventListener('loadedmetadata', () => { console.log(`${player.id} metadata loaded`); updateDuration(); });
                 player.addEventListener('ended', playNextTrack); // Play next on end
                 player.addEventListener('error', (e) => handleError(e, player.id)); // Ensure error handling is attached
                 player.addEventListener('playing', () => { console.log(`${player.id} 'playing' event fired.`); isPlaying = true; updatePlayPauseButton(); }); // Update state on playing
                 player.addEventListener('pause', () => { console.log(`${player.id} 'pause' event fired.`); isPlaying = false; updatePlayPauseButton(); }); // Update state on pause
                 // Remove 'canplay' listener for now as we trigger play manually
             });
             console.log("Event listeners added.");


            // --- File Handling ---
            function handleFileSelection(event){
                console.log("handleFileSelection triggered."); const files=event.target.files;
                console.log(`Files selected: ${files.length}`,files); if(files.length===0){console.log("No files selected.");return;}
                trackList=Array.from(files); renderFileList();
                if(trackList.length>0){
                    console.log("Loading track 0, but NOT auto-playing.");
                    // Load the first track's info and prepare it, but don't play
                    loadTrack(0, false); // Pass false to indicate no autoplay
                }
            }
            function renderFileList(){
                console.log("Rendering file list..."); fileListDisplay.innerHTML='';
                trackList.forEach((file,index)=>{ const li=document.createElement('li');li.textContent=file.name;li.dataset.index=index;
                li.addEventListener('click',()=>{console.log(`Playlist item clicked: Index ${index}`); loadTrack(index, true); }); // Load and PLAY on click
                fileListDisplay.appendChild(li); }); console.log("File list rendered.");
            }

            // --- NEW Load Track Function (Separated from Play) ---
            function loadTrack(index, autoPlayOnClick = false) {
                console.log(`loadTrack called with index: ${index}, autoPlay: ${autoPlayOnClick}`);
                if (index < 0 || index >= trackList.length) { console.warn(`Invalid track index: ${index}`); return; }

                // Revoke previous URL
                if (currentObjectURL) { console.log("Revoking previous Object URL:", currentObjectURL); URL.revokeObjectURL(currentObjectURL); currentObjectURL = null; }

                // Stop current playback before loading new track
                if (currentAudioSource) {
                    currentAudioSource.pause();
                    currentAudioSource.removeAttribute('src'); // Fully remove src
                    currentAudioSource.load(); // Reset element state
                     console.log(`Paused and reset ${currentAudioSource.id}`);
                }


                currentTrackIndex = index;
                const file = trackList[currentTrackIndex];
                console.log(`Loading file: ${file.name}, Type: ${file.type || 'N/A'}`);

                // Update UI immediately
                trackTitle.textContent = `Cargando: ${file.name}...`; trackArtistAlbum.textContent = "";
                albumArtImg.style.display = 'none'; artPlaceholder.style.display = 'inline-block';
                isPlaying = false; updatePlayPauseButton(); updatePlayingListItem(); progressBar.value = 0;
                currentTimeDisplay.textContent = formatTime(0); durationDisplay.textContent = formatTime(0);

                try {
                    currentObjectURL = URL.createObjectURL(file);
                    console.log("Created Object URL:", currentObjectURL);
                } catch (e) { console.error("Error creating Object URL:", e); handleError(e, 'createObjectURL'); return; }

                // Determine player
                const fileNameLower = file.name.toLowerCase();
                 if (fileNameLower.endsWith('.mp4')) {
                     console.log("Selecting videoPlayer for MP4."); currentAudioSource = videoPlayer;
                 } else {
                     console.log("Selecting audioPlayer."); currentAudioSource = audioPlayer;
                 }

                console.log(`Setting src for ${currentAudioSource.id}: ${currentObjectURL}`);
                currentAudioSource.src = currentObjectURL;
                // Explicitly call load() after setting src might help consistency
                currentAudioSource.load();
                console.log(`Src set for ${currentAudioSource.id}. Element will load.`);

                 // Load metadata as soon as possible after setting src
                 loadMetadata(file);

                // --- IMPORTANT: Only play if triggered by list click ---
                if (autoPlayOnClick) {
                    console.log("Auto-playing track due to list click.");
                    // We still might want to wait for 'canplay' before playing here
                    // to avoid issues if metadata/loading is slow. Let's re-add it just for this autoPlay.
                    const playWhenReadyOnClick = () => {
                        console.log(`'canplay' triggered for autoPlay. Attempting play.`);
                         currentAudioSource.play().catch(e => {
                             console.error("Error auto-playing track:", e);
                             handleError(e, `${currentAudioSource.id} (autoPlay promise)`);
                         });
                         currentAudioSource.removeEventListener('canplay', playWhenReadyOnClick);
                         currentAudioSource.removeEventListener('error', errorBeforeReadyOnClick); // Clean up error listener too
                    };
                     const errorBeforeReadyOnClick = (e) => {
                         console.error(`Error on ${currentAudioSource.id} before autoPlay 'canplay':`, e);
                         handleError(e, `${currentAudioSource.id} (loading for autoPlay)`);
                          currentAudioSource.removeEventListener('canplay', playWhenReadyOnClick);
                         currentAudioSource.removeEventListener('error', errorBeforeReadyOnClick);
                     };

                     currentAudioSource.addEventListener('canplay', playWhenReadyOnClick, { once: true });
                     currentAudioSource.addEventListener('error', errorBeforeReadyOnClick, { once: true });

                } else {
                    console.log("Track loaded, waiting for user interaction (Play button).");
                     // Ensure UI reflects that it's paused but ready
                     isPlaying = false;
                     updatePlayPauseButton();
                }
            }


            // --- Playback Controls --- (Modified toggle, next, prev)
             function togglePlayPause(){
                 console.log("togglePlayPause called. isPlaying:", isPlaying);
                 // Check if a source is loaded and ready (or loading)
                 if (!currentAudioSource || !currentAudioSource.src || currentAudioSource.src === window.location.href || currentTrackIndex < 0) {
                      console.log("No track loaded/ready to play/pause.");
                      // Optional: try loading first track if none selected?
                      // if (trackList.length > 0 && currentTrackIndex < 0) { loadTrack(0, true); }
                      return;
                  }

                 if (isPlaying) {
                     console.log("Pausing...");
                     currentAudioSource.pause(); // isPlaying state updated by 'pause' event listener
                 } else {
                     console.log("Attempting play via button...");
                     currentAudioSource.play().catch(e => {
                         console.error("Error playing via button:", e);
                         handleError(e, `${currentAudioSource.id} (play button promise)`);
                         // Ensure state reflects failure
                          isPlaying = false; updatePlayPauseButton();
                     });
                     // isPlaying state updated by 'playing' event listener
                 }
                 // Note: isPlaying state is now primarily managed by 'playing' and 'pause' event listeners for accuracy
             }

             function playNextTrack(){
                 if (trackList.length === 0) return; let nextIndex = currentTrackIndex + 1;
                 if (nextIndex >= trackList.length) { nextIndex = 0; }
                 console.log("playNextTrack -> calling loadTrack with index:", nextIndex);
                 loadTrack(nextIndex, true); // Load and auto-play next
             }
             function playPreviousTrack(){
                 if (trackList.length === 0) return;
                 if (currentAudioSource.currentTime > 3) {
                     console.log("playPreviousTrack -> restarting current track");
                     currentAudioSource.currentTime = 0;
                     // Ensure playback continues if it was playing
                     if(wasPlayingBeforeRestart) { // Need to track this state if restart pause is undesired
                        currentAudioSource.play().catch(e => handleError(e, 'restart'));
                     }
                 } else {
                     let prevIndex = currentTrackIndex - 1; if (prevIndex < 0) { prevIndex = trackList.length - 1; }
                     console.log("playPreviousTrack -> calling loadTrack with index:", prevIndex);
                     loadTrack(prevIndex, true); // Load and auto-play previous
                 }
                 // We need a variable to track if restarting should resume play
                 // Let's simplify: restart always goes to beginning, paused. User hits play.
                 // OR better: check isPlaying state before seeking
                 const wasPlayingBeforeRestart = isPlaying;
                 if (currentAudioSource.currentTime > 3) {
                     console.log("playPreviousTrack -> restarting current track");
                     currentAudioSource.currentTime = 0;
                     if(!wasPlayingBeforeRestart) { // If it wasn't playing, pause it after seeking
                         currentAudioSource.pause();
                         isPlaying = false;
                         updatePlayPauseButton();
                     } else {
                         // If it WAS playing, it should automatically resume or the 'playing' event will fire.
                         // Ensure the play button state reflects playing if it resumes quickly.
                         updatePlayPauseButton(); // Update button just in case
                     }

                 } else { /* ... load prev track ... */ }
             }


            // --- UI Updates --- (Identical)
            function updatePlayPauseButton(){playIcon.classList.toggle('hidden',isPlaying);pauseIcon.classList.toggle('hidden',!isPlaying);playPauseButton.title=isPlaying?"Pausa":"Reproducir";}
            function updateProgress(){if(!currentAudioSource||!isFinite(currentAudioSource.duration))return;const currentTime=currentAudioSource.currentTime;progressBar.value=currentTime;currentTimeDisplay.textContent=formatTime(currentTime);}
            function updateDuration(){if(!currentAudioSource||!isFinite(currentAudioSource.duration)){durationDisplay.textContent="0:00";progressBar.max=0;return;} const duration=currentAudioSource.duration;durationDisplay.textContent=formatTime(duration);progressBar.max=duration;}
            function updatePlayingListItem(){fileListDisplay.querySelectorAll('li').forEach(li=>{li.classList.remove('playing');});const currentLi=fileListDisplay.querySelector(`li[data-index="${currentTrackIndex}"]`);if(currentLi){currentLi.classList.add('playing');currentLi.scrollIntoView({behavior:'smooth',block:'nearest'});}}

            // --- Seek & Volume --- (Identical)
            function handleSeek(){if(!currentAudioSource||!isFinite(currentAudioSource.duration))return;currentAudioSource.currentTime=progressBar.value;}
            function handleVolumeChange(){if(!currentAudioSource)return;currentAudioSource.volume=volumeSlider.value;}

            // --- Metadata Handling --- (Identical, ensure jsmediatags check inside)
             function loadMetadata(file){ console.log(`Attempting metadata for: ${file.name}`); albumArtImg.style.display='none';artPlaceholder.style.display='inline-block'; if(!jsmediatags){console.warn("jsmediatags not loaded.");albumArtImg.alt='Sin carátula'; return;} jsmediatags.read(file,{onSuccess:function(tag){console.log("Metadata loaded:",tag.tags);const t=tag.tags;trackTitle.textContent=t.title||file.name;trackArtistAlbum.textContent=[t.artist,t.album].filter(Boolean).join(' - '); if(t.picture){const{data:d,format:f}=t.picture;let b="";for(let i=0;i<d.length;i++){b+=String.fromCharCode(d[i]);} const dataUrl=`data:${f};base64,${window.btoa(b)}`; albumArtImg.src=dataUrl;albumArtImg.alt=t.album||'Album Art';albumArtImg.style.display='block';artPlaceholder.style.display='none';} else{albumArtImg.src='';albumArtImg.alt='Sin carátula';albumArtImg.style.display='none';artPlaceholder.style.display='inline-block';}},onError:function(error){console.log(`Metadata error:`,error.type,error.info);/* Reset UI */ trackTitle.textContent=file.name;trackArtistAlbum.textContent="(sin metadatos)";albumArtImg.src='';albumArtImg.alt='Sin carátula';albumArtImg.style.display='none';artPlaceholder.style.display='inline-block';}}); }

            // --- Utility Functions --- (Identical)
             function formatTime(seconds){const secs=Math.floor(seconds||0);const minutes=Math.floor(secs/60);const remainingSeconds=secs%60;return`${minutes}:${remainingSeconds<10?'0':''}${remainingSeconds}`;}
             function handleError(e,sourceId){console.error(`---- Playback Error from ${sourceId} ----`);console.error("Error Event:",e);let errorDetails="desconocido";if(currentAudioSource&&currentAudioSource.error){console.error("MediaError Code:",currentAudioSource.error.code);console.error("MediaError Message:",currentAudioSource.error.message);errorDetails=`Código: ${currentAudioSource.error.code}`;} trackTitle.textContent="Error de Reproducción";trackArtistAlbum.textContent=trackList[currentTrackIndex]?.name||"Archivo desconocido";albumArtImg.src='';albumArtImg.alt='Error';albumArtImg.style.display='none';artPlaceholder.style.display='inline-block';isPlaying=false;updatePlayPauseButton();if(currentAudioSource)currentAudioSource.src='';alert(`Error al reproducir el archivo (${errorDetails}). Revisa la consola (F12).`);}

            console.log("Initial setup complete. Ready for file selection.");
        }); // End of window.load listener
        // --- JavaScript Ends ---
    </script>
</body>
</html>
